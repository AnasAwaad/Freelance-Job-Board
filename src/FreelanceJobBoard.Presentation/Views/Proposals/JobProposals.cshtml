@model List<FreelanceJobBoard.Presentation.Models.ViewModels.ProposalViewModel>
@using FreelanceJobBoard.Domain.Constants
@{
    ViewData["Title"] = "Job Proposals";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
    var job = ViewBag.Job as FreelanceJobBoard.Presentation.Models.ViewModels.JobViewModel;
    var currentStatus = ViewBag.CurrentStatus as string;
    
    // Check if there's already an accepted proposal for this job
    var hasAcceptedProposal = Model.Any(p => p.Status == "Accepted");
}

<div class="d-flex flex-column flex-column-fluid">
    <!--begin::Toolbar-->
    <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
        <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
            <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
                <h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column justify-content-center my-0">Proposals for: @job?.Title</h1>
                <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                    <li class="breadcrumb-item text-muted">
                        <a asp-controller="Jobs" asp-action="MyJobs" class="text-muted text-hover-primary">My Jobs</a>
                    </li>
                    <li class="breadcrumb-item">
                        <span class="bullet bg-gray-400 w-5px h-2px"></span>
                    </li>
                    <li class="breadcrumb-item text-muted">Proposals</li>
                </ul>
            </div>
            <div class="d-flex align-items-center gap-2 gap-lg-3">
                <a asp-controller="Jobs" asp-action="Details" asp-route-id="@job?.Id" class="btn btn-sm fw-bold btn-secondary">
                    <i class="ki-duotone ki-arrow-left fs-4"></i>
                    Back to Job
                </a>
            </div>
        </div>
    </div>
    <!--end::Toolbar-->

    <!--begin::Content-->
    <div id="kt_app_content" class="app-content flex-column-fluid">
        <div id="kt_app_content_container" class="app-container container-xxl">
            
            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["Success"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (hasAcceptedProposal)
            {
                <div class="alert alert-light-info d-flex align-items-center p-5 mb-6">
                    <i class="ki-duotone ki-shield-tick fs-2hx text-info me-4">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    <div class="d-flex flex-column">
                        <h4 class="mb-1 text-dark">Job Assigned</h4>
                        <span>This job already has an accepted proposal. Other proposals cannot be accepted until the current assignment is cancelled.</span>
                    </div>
                </div>
            }

            <!--begin::Card-->
            <div class="card">
                <!--begin::Card header-->
                <div class="card-header border-0 pt-6">
                    <div class="card-title">
                        <div class="d-flex align-items-center position-relative my-1">
                            <h3 class="fw-bold">
                                @{
                                    var filteredTitle = currentStatus switch
                                    {
                                        "Accepted" => "Accepted Proposals",
                                        "Rejected" => "Rejected Proposals", 
                                        "Submitted" => "New Proposals",
                                        "UnderReview" => "Under Review",
                                        _ => "All Proposals"
                                    };
                                }
                                @filteredTitle (@Model.Count)
                            </h3>
                        </div>
                    </div>
                    <div class="card-toolbar">
                        <div class="d-flex align-items-center gap-2">
                            @{
                                var allCount = Model.Count;
                                var submittedCount = Model.Count(p => p.Status == "Submitted");
                                var acceptedCount = Model.Count(p => p.Status == "Accepted");
                                var rejectedCount = Model.Count(p => p.Status == "Rejected");
                                var underReviewCount = Model.Count(p => p.Status == "UnderReview");
                            }
                            <div class="btn-group" role="group">
                                <a asp-action="JobProposals" asp-route-jobId="@job?.Id" 
                                   class="btn btn-sm btn-@(string.IsNullOrEmpty(currentStatus) ? "primary" : "light-primary")">
                                    All (@allCount)
                                </a>
                                <a asp-action="JobProposals" asp-route-jobId="@job?.Id" asp-route-status="Submitted"
                                   class="btn btn-sm btn-@(currentStatus == "Submitted" ? "warning" : "light-warning")">
                                    New (@submittedCount)
                                </a>
                                <a asp-action="JobProposals" asp-route-jobId="@job?.Id" asp-route-status="Accepted"
                                   class="btn btn-sm btn-@(currentStatus == "Accepted" ? "success" : "light-success")">
                                    Accepted (@acceptedCount)
                                </a>
                                <a asp-action="JobProposals" asp-route-jobId="@job?.Id" asp-route-status="Rejected"
                                   class="btn btn-sm btn-@(currentStatus == "Rejected" ? "danger" : "light-danger")">
                                    Rejected (@rejectedCount)
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end::Card header-->

                <!--begin::Card body-->
                <div class="card-body py-4">
                    @if (Model.Any())
                    {
                        @foreach (var proposal in Model.OrderByDescending(p => p.Id))
                        {
                            var statusClass = proposal.Status switch
                            {
                                "Accepted" => "badge-light-success",
                                "Rejected" => "badge-light-danger",
                                "UnderReview" => "badge-light-warning",
                                _ => "badge-light-primary"
                            };

                            var cardBorderClass = proposal.Status switch
                            {
                                "Accepted" => "border-success",
                                "Rejected" => "border-danger",
                                _ => ""
                            };
                            
                            <div class="card mb-5 @cardBorderClass">
                                <div class="card-header">
                                    <div class="card-title">
                                        <div class="d-flex align-items-center">
                                            <div class="symbol symbol-45px me-5">
                                                <div class="symbol-label fs-3 bg-light-primary text-primary">
                                                    @(proposal.ClientName?.Substring(0, 1).ToUpper() ?? "F")
                                                </div>
                                            </div>
                                            <div class="d-flex flex-column">
                                                <span class="fw-bold fs-5 text-gray-900">@(proposal.ClientName ?? "Freelancer")</span>
                                                <span class="text-gray-400 fw-semibold fs-7">Proposal #@proposal.Id</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-toolbar">
                                        <span class="badge @statusClass fs-7 fw-bold">@proposal.Status</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-lg-8">
                                            <div class="mb-5">
                                                <h4 class="fs-6 fw-bold text-gray-900 mb-2">Cover Letter</h4>
                                                <p class="text-gray-700 fs-6">@proposal.CoverLetter</p>
                                            </div>

                                            @if (proposal.Attachments.Any())
                                            {
                                                <div class="mb-5">
                                                    <h4 class="fs-6 fw-bold text-gray-900 mb-2">Portfolio Files</h4>
                                                    <div class="d-flex flex-wrap gap-2">
                                                        @foreach (var attachment in proposal.Attachments)
                                                        {
                                                            <a href="@attachment.FileUrl" target="_blank" class="btn btn-sm btn-light-info">
                                                                <i class="ki-duotone ki-document fs-4 me-1">
                                                                    <span class="path1"></span>
                                                                    <span class="path2"></span>
                                                                </i>
                                                                @attachment.FileName
                                                            </a>
                                                        }
                                                    </div>
                                                </div>
                                            }

                                            @if (!string.IsNullOrEmpty(proposal.ClientFeedback))
                                            {
                                                <div class="alert alert-light-info">
                                                    <h4 class="alert-heading fs-6 fw-bold">Your Feedback:</h4>
                                                    <p class="mb-0">@proposal.ClientFeedback</p>
                                                    <small class="text-muted">@proposal.ReviewedAt?.ToString("MMM dd, yyyy 'at' hh:mm tt")</small>
                                                </div>
                                            }
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="d-flex flex-column gap-5">
                                                <div class="d-flex flex-stack">
                                                    <span class="text-gray-700 fw-bold fs-6">Bid Amount:</span>
                                                    <span class="text-dark fw-bold fs-4">$@proposal.BidAmount.ToString("N2")</span>
                                                </div>
                                                
                                                <div class="d-flex flex-stack">
                                                    <span class="text-gray-700 fw-bold fs-6">Timeline:</span>
                                                    <span class="text-dark fw-bold fs-6">@proposal.EstimatedTimelineDays days</span>
                                                </div>

                                                @if (proposal.ReviewedAt.HasValue)
                                                {
                                                    <div class="d-flex flex-stack">
                                                        <span class="text-gray-700 fw-bold fs-6">Reviewed:</span>
                                                        <span class="text-dark fw-bold fs-6">@proposal.ReviewedAt.Value.ToString("MMM dd")</span>
                                                    </div>
                                                }

                                                @* Only show accept/reject buttons if proposal is pending AND no proposal has been accepted yet *@
                                                @if ((proposal.Status == "Submitted" || proposal.Status == "UnderReview") && !hasAcceptedProposal)
                                                {
                                                    <div class="separator my-3"></div>
                                                    <div class="d-flex flex-column gap-2">
                                                        <button type="button" class="btn btn-success btn-sm" 
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#acceptModal" 
                                                                data-proposal-id="@proposal.Id"
                                                                data-freelancer-name="@(proposal.ClientName ?? "Freelancer")"
                                                                data-bid-amount="@proposal.BidAmount.ToString("N2")">
                                                            <i class="ki-duotone ki-check fs-4 me-1">
                                                                <span class="path1"></span>
                                                                <span class="path2"></span>
                                                            </i>
                                                            Accept Proposal
                                                        </button>
                                                        
                                                        <button type="button" class="btn btn-light-danger btn-sm" 
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#rejectModal" 
                                                                data-proposal-id="@proposal.Id"
                                                                data-freelancer-name="@(proposal.ClientName ?? "Freelancer")">
                                                            <i class="ki-duotone ki-cross fs-4 me-1">
                                                                <span class="path1"></span>
                                                                <span class="path2"></span>
                                                            </i>
                                                            Reject Proposal
                                                        </button>
                                                    </div>
                                                }
                                                else if ((proposal.Status == "Submitted" || proposal.Status == "UnderReview") && hasAcceptedProposal)
                                                {
                                                    <div class="separator my-3"></div>
                                                    <div class="alert alert-light-warning p-3">
                                                        <small class="text-muted">
                                                            <i class="ki-duotone ki-information fs-5 me-1">
                                                                <span class="path1"></span>
                                                                <span class="path2"></span>
                                                                <span class="path3"></span>
                                                            </i>
                                                            Cannot accept - job already assigned
                                                        </small>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-10">
                            <div class="mb-7">
                                <i class="ki-duotone ki-questionnaire-tablet fs-3x text-gray-400">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                            </div>
                            <h3 class="text-gray-600 fw-semibold mb-2">No Proposals Found</h3>
                            <p class="text-gray-400">
                                @if (!string.IsNullOrEmpty(currentStatus))
                                {
                                    <span>No proposals with status "@currentStatus" found for this job.</span>
                                }
                                else
                                {
                                    <span>This job hasn't received any proposals yet.</span>
                                }
                            </p>
                        </div>
                    }
                </div>
                <!--end::Card body-->
            </div>
            <!--end::Card-->
        </div>
    </div>
    <!--end::Content-->
</div>

<!-- Accept Proposal Modal -->
<div class="modal fade" id="acceptModal" tabindex="-1" aria-labelledby="acceptModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="UpdateStatus" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="acceptModalLabel">Accept Proposal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="proposalId" id="acceptProposalId" />
                    <input type="hidden" name="status" value="@ProposalStatus.Accepted" />
                    <input type="hidden" name="jobId" value="@job?.Id" />
                    
                    <div class="alert alert-warning">
                        <i class="ki-duotone ki-warning-2 fs-2 me-2">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                        <strong>Important:</strong> Accepting this proposal will automatically reject all other proposals for this job.
                    </div>
                    
                    <p>Are you sure you want to accept the proposal from <strong id="acceptFreelancerName"></strong> for <strong>$<span id="acceptBidAmount"></span></strong>?</p>
                    
                    <div class="mb-3">
                        <label for="acceptFeedback" class="form-label">Message to Freelancer (Optional)</label>
                        <textarea name="feedback" id="acceptFeedback" class="form-control" rows="3" 
                                  placeholder="Welcome message or project details..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="ki-duotone ki-check fs-4"></i>
                        Accept Proposal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reject Proposal Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="UpdateStatus" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectModalLabel">Reject Proposal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="proposalId" id="rejectProposalId" />
                    <input type="hidden" name="status" value="@ProposalStatus.Rejected" />
                    <input type="hidden" name="jobId" value="@job?.Id" />
                    
                    <p>Are you sure you want to reject the proposal from <strong id="rejectFreelancerName"></strong>?</p>
                    
                    <div class="mb-3">
                        <label for="rejectFeedback" class="form-label">Reason for Rejection (Optional)</label>
                        <textarea name="feedback" id="rejectFeedback" class="form-control" rows="3" 
                                  placeholder="Let the freelancer know why their proposal wasn't selected..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="ki-duotone ki-cross fs-4"></i>
                        Reject Proposal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle accept modal
            document.getElementById('acceptModal').addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const proposalId = button.getAttribute('data-proposal-id');
                const freelancerName = button.getAttribute('data-freelancer-name');
                const bidAmount = button.getAttribute('data-bid-amount');
                
                document.getElementById('acceptProposalId').value = proposalId;
                document.getElementById('acceptFreelancerName').textContent = freelancerName;
                document.getElementById('acceptBidAmount').textContent = bidAmount;
            });

            // Handle reject modal
            document.getElementById('rejectModal').addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const proposalId = button.getAttribute('data-proposal-id');
                const freelancerName = button.getAttribute('data-freelancer-name');
                
                document.getElementById('rejectProposalId').value = proposalId;
                document.getElementById('rejectFreelancerName').textContent = freelancerName;
            });
        });
    </script>
}